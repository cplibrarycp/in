<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>വായന ചരിത്രം | THRIPUDI LIBRARY</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
    
    <style>
        :root { 
            --primary-teal: #00897B; --secondary-dark: #004D40; --background-light: #E0F2F1;
            --text-color: #263238; --light-text: #FFFFFF; --card-bg: #FFFFFF; --outline-color: #B2DFDB;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-light); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        .container { width: 92%; margin: 0 auto; max-width: 1200px; }

        /* --- ഹെഡർ (ത്രിപുടി മാസ്റ്റർ) --- */
        header { background-color: var(--secondary-dark); padding: 5px 0; height: 90px; display: flex; align-items: center; color: white; }
        .navbar { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .logo-container { display: flex; align-items: center; gap: 12px; color: white !important; text-decoration: none; }
        .logo-img { height: 65px; }
        .logo-text { font-size: 1.5em; font-weight: 700; }

        /* --- ഹിസ്റ്ററി സെക്ഷൻ --- */
        .history-section { padding: 40px 0; flex: 1; }
        h1 { color: var(--secondary-dark); text-align: center; margin-bottom: 30px; }

        .history-grid { display: grid; gap: 20px; grid-template-columns: repeat(2, 1fr); }
        @media (min-width: 1024px) { .history-grid { grid-template-columns: repeat(5, 1fr); } }

        .history-card { background: white; border-radius: 10px; overflow: hidden; position: relative; border: 2px solid var(--outline-color); transition: 0.3s; }
        .history-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .img-box { height: 200px; width: 100%; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }

        .info-box { padding: 10px; text-align: center; }
        .book-title { font-weight: 700; font-size: 0.9em; height: 2.6em; overflow: hidden; color: var(--secondary-dark); margin-bottom: 5px; }
        .view-date { font-size: 0.75em; color: #666; }

        /* --- ഡിലീറ്റ് ബട്ടൺ --- */
        .delete-btn {
            position: absolute; top: 10px; right: 10px; background: rgba(255, 0, 0, 0.8);
            color: white; border: none; width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 0.8em; z-index: 10; transition: 0.2s;
        }
        .delete-btn:hover { background: red; transform: scale(1.1); }

        .empty-msg { text-align: center; padding: 50px; color: #666; font-style: italic; }

        /* --- ഫൂട്ടർ --- */
        footer { background: var(--secondary-dark); color: white; text-align: center; padding: 20px 0; margin-top: 40px; }
    </style>
</head>
<body>

<header>
    <div class="container navbar">
        <a href="dashboard.html" class="logo-container">
            <img src="https://drive.google.com/thumbnail?sz=w600&id=1DuMrsRg-QsW9mf5lV4uK8eWn8oiofz5r" alt="Logo" class="logo-img">
            <span class="logo-text">THRIPUDI</span>
        </a>
        <a href="collection.html" style="color:white; text-decoration:none; font-weight:600;"><i class="fas fa-arrow-left"></i> തിരികെ ശേഖരത്തിലേക്ക്</a>
    </div>
</header>

<section class="history-section">
    <div class="container">
        <h1>വായന ചരിത്രം</h1>
        <div id="history-container" class="history-grid">
            </div>
    </div>
</section>

<footer>
    <div class="container">
        <p>© 2025 THRIPUDI LIBRARY. നന്ദകുമാർ, നിങ്ങളുടെ വായന തുടരൂ.</p>
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBzwhpHmeZdLf_nZrcPQirlnpj3Vhg9EqA", authDomain: "thripudilibrary.firebaseapp.com", projectId: "thripudilibrary" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            loadHistory(user.uid);
        } else {
            window.location.href = "login.html";
        }
    });

    function loadHistory(uid) {
        const key = 'history_' + uid;
        const history = JSON.parse(localStorage.getItem(key)) || [];
        const container = document.getElementById('history-container');

        if (history.length === 0) {
            container.innerHTML = '<div class="empty-msg" style="grid-column: 1/-1;">നിങ്ങൾ ഇതുവരെ പുസ്തകങ്ങളൊന്നും വായിച്ചിട്ടില്ല.</div>';
            return;
        }

        container.innerHTML = history.map((item, index) => `
            <div class="history-card">
                <button class="delete-btn" onclick="deleteHistoryItem('${uid}', ${index})" title="ചരിത്രത്തിൽ നിന്ന് നീക്കം ചെയ്യുക">
                    <i class="fas fa-trash"></i>
                </button>
                <a href="${item.link}" style="text-decoration:none; color:inherit;">
                    <div class="img-box">
                        <img src="${item.image}" alt="${item.title}">
                    </div>
                    <div class="info-box">
                        <div class="book-title">${item.title}</div>
                        <div class="view-date">${item.date}</div>
                    </div>
                </a>
            </div>
        `).join('');
    }

    // ഓരോ പുസ്തകവും നീക്കം ചെയ്യാനുള്ള ഫങ്ക്ഷൻ
    window.deleteHistoryItem = function(uid, index) {
        if(confirm("ഈ പുസ്തകം ചരിത്രത്തിൽ നിന്ന് നീക്കം ചെയ്യണോ?")) {
            const key = 'history_' + uid;
            let history = JSON.parse(localStorage.getItem(key)) || [];
            history.splice(index, 1); // ആ ഇൻഡക്സിലുള്ള ഐറ്റം മാത്രം കളയുന്നു
            localStorage.setItem(key, JSON.stringify(history));
            loadHistory(uid); // ലിസ്റ്റ് പുതുക്കുന്നു
        }
    }
</script>

</body>
</html>
