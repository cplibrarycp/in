<!DOCTYPE html>
<html lang="ml">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>വായനാ ചരിത്രം | THRIPUDI LIBRARY</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
<style>
    /* --- THEMES --- */
    :root {
        --primary-orange: #00897B; 
        --secondary-dark: #004D40; 
        --background-light: #E0F2F1;
        --text-color: #263238;
        --light-text: #FFFFFF;
        --card-bg: #FFFFFF;
        --outline-color: #B2DFDB;
        --danger-color: #d32f2f;
    }

    /* --- STICKY FOOTER FIX --- */
    html, body { height: 100%; margin: 0; padding: 0; }
    body { 
        font-family: 'Poppins', sans-serif; 
        background-color: var(--background-light); 
        color: var(--text-color); 
        line-height: 1.6;
        display: flex; flex-direction: column; min-height: 100vh;
    }
    .container { width: 90%; margin: 0 auto; max-width: 1200px; }
    a { text-decoration: none; }

    /* Header */
    header { background-color: var(--secondary-dark); padding: 15px 0; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); position: sticky; top: 0; z-index: 1000; flex-shrink: 0; }
    .navbar { display: flex; justify-content: space-between; align-items: center; }
    .logo { font-size: 1.8em; font-weight: 700; color: var(--light-text); }
    .nav-links { display: flex; align-items: center; gap: 15px; }
    .nav-item { color: var(--light-text); font-weight: 600; font-size: 0.85em; text-transform: uppercase; padding: 8px 18px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; transition: 0.3s; }
    .nav-item:hover { background-color: #ffffff; color: var(--secondary-dark); transform: translateY(-2px); }

    /* Profile */
    .user-profile { display: flex; align-items: center; margin-left: 25px; padding-left: 25px; border-left: 1px solid rgba(255,255,255,0.2); position: relative; cursor: pointer; }
    .user-avatar { width: 32px; height: 32px; background-color: #fff; color: var(--primary-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
    .user-info { color: #fff; font-size: 0.85em; text-align: left; }
    .user-name { font-weight: 600; display: block; }
    .user-role { font-size: 0.8em; opacity: 0.8; }
    .profile-dropdown { display: none; position: absolute; top: 100%; right: 0; background-color: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 5px; min-width: 160px; margin-top: 10px; z-index: 1001; }
    .user-profile:hover .profile-dropdown { display: block; }
    .profile-dropdown a { display: block; padding: 10px 15px; color: var(--text-color); font-size: 0.9em; border-bottom: 1px solid #eee; }
    .profile-dropdown a:hover { background-color: var(--background-light); color: var(--primary-orange); }

    /* History Section */
    .history-section { padding: 50px 0; min-height: 60vh; flex: 1 0 auto; }
    
    .section-header {
        display: flex; justify-content: space-between; align-items: center;
        border-bottom: 3px solid var(--primary-orange);
        padding-bottom: 10px; margin-bottom: 30px;
    }
    
    .history-section h1 { font-size: 2em; color: var(--secondary-dark); margin: 0; }

    .clear-btn {
        background-color: var(--danger-color); color: white; border: none;
        padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 0.9em;
        transition: 0.3s; display: none; /* Initially hidden */
    }
    .clear-btn:hover { background-color: #b71c1c; }

    /* History Grid */
    .history-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    
    .history-card {
        background: var(--card-bg); padding: 15px; border-radius: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        display: flex; align-items: center; gap: 15px;
        border-left: 5px solid var(--primary-orange);
        transition: transform 0.3s;
    }
    .history-card:hover { transform: translateX(5px); box-shadow: 0 8px 20px rgba(0, 77, 64, 0.15); }
    
    .history-thumb { width: 60px; height: 85px; object-fit: cover; border-radius: 5px; }
    .history-details { flex: 1; }
    .history-title { font-weight: 700; color: var(--secondary-dark); font-size: 1em; display: block; margin-bottom: 5px; }
    .history-date { font-size: 0.85em; color: #777; display: block; margin-bottom: 10px; }
    .read-link { font-size: 0.85em; color: var(--primary-orange); font-weight: 600; text-transform: uppercase; }
    
    .no-history { text-align: center; color: #777; font-size: 1.2em; margin-top: 50px; width: 100%; grid-column: 1 / -1; }

    /* Footer */
    footer { background-color: var(--secondary-dark); color: var(--light-text); padding: 40px 0; text-align: center; font-size: 0.9em; margin-top: auto; flex-shrink: 0; }
    .footer-links a { color: var(--light-text); margin: 0 10px; opacity: 0.8; transition: 0.3s; }
    .footer-links a:hover { opacity: 1; color: var(--primary-orange); }
</style>
</head>
<body>

<header>
    <div class="container navbar">
        <a class="logo" href="dashboard.html">THRIPUDI LIBRARY</a>
        <div class="nav-links">
            <a class="nav-item" href="dashboard.html"><i class="fas fa-home"></i> Home</a>
            <a class="nav-item" href="collection.html"><i class="fas fa-book"></i> ഗ്രന്ഥശേഖരം</a>
            <a class="nav-item" href="about.html"><i class="fas fa-info-circle"></i> ABOUT</a>
            <a class="nav-item" href="contact.html"><i class="fas fa-envelope"></i> CONTACT</a>

            <div class="user-profile" id="profile-section">
                <div class="user-avatar" id="userAvatar"><i class="fas fa-user"></i></div>
                <div class="user-info">
                    <span class="user-name" id="display-name">Guest</span>
                    <span class="user-role">Member</span>
                </div>
                <div class="profile-dropdown">
                    <a href="profile.html">Profile Settings</a>
                    <a href="history.html" style="background: #E0F2F1; color: #00897B;">Reading History</a>
                    <a href="#" id="logout-link" style="color: #d32f2f; display:none;">Logout</a>
                </div>
            </div>
        </div>
    </div>
</header>

<section class="history-section">
    <div class="container">
        <div class="section-header">
            <h1>വായനാ ചരിത്രം</h1>
            <button class="clear-btn" id="clearBtn" onclick="clearHistory()"><i class="fas fa-trash-alt"></i> എല്ലാം മായ്ക്കുക</button>
        </div>
        <div class="history-list" id="historyContainer">
            <p class="no-history">ലോഗിൻ വിവരങ്ങൾ പരിശോധിക്കുന്നു...</p>
        </div>
    </div>
</section>

<footer>
    <div class="container">
        <p>© 2025 THRIPUDI LIBRARY. എല്ലാ അവകാശങ്ങളും നിക്ഷിപ്തം.</p>
        <div class="footer-links">
            <a href="privacy-policy.html">സ്വകാര്യതാ നയം</a> |
            <a href="terms.html">ഉപയോഗ നിബന്ധനകൾ</a> |
            <a href="#"><i class="fab fa-twitter"></i></a>
            <a href="#"><i class="fab fa-facebook-f"></i></a>
        </div>
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBzwhpHmeZdLf_nZrcPQirlnpj3Vhg9EqA", authDomain: "thripudilibrary.firebaseapp.com", projectId: "thripudilibrary", storageBucket: "thripudilibrary.firebasestorage.app", messagingSenderId: "887018912750", appId: "1:887018912750:web:cc05190a72b13db816acff", measurementId: "G-B59RDW4KG4" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    let currentUserId = null;

    onAuthStateChanged(auth, (user) => {
        const nameDisplay = document.getElementById('display-name');
        const avatarDiv = document.getElementById('userAvatar');
        const logoutBtn = document.getElementById('logout-link');

        if (user) {
            currentUserId = user.uid;
            localStorage.setItem('libraryUser', 'true'); // Keep logged in state
            if(logoutBtn) logoutBtn.style.display = 'block';
            
            const displayName = user.displayName ? user.displayName.split(' ')[0] : "User";
            if(nameDisplay) nameDisplay.textContent = displayName;
            if(user.photoURL && avatarDiv) avatarDiv.innerHTML = `<img src="${user.photoURL}" alt="Profile">`;

            // ലോഗിൻ ആയ ഉടൻ ഹിസ്റ്ററി ലോഡ് ചെയ്യുന്നു
            renderHistory(user.uid);
        } else {
            localStorage.removeItem('libraryUser');
            if(logoutBtn) logoutBtn.style.display = 'none';
            document.getElementById('historyContainer').innerHTML = '<p class="no-history">ചരിത്രം കാണാൻ ദയവായി ലോഗിൻ ചെയ്യുക.</p>';
        }
    });

    const logoutLink = document.getElementById('logout-link');
    if(logoutLink) {
        logoutLink.addEventListener('click', (e) => {
            e.preventDefault();
            signOut(auth).then(() => { 
                localStorage.removeItem('libraryUser'); 
                window.location.href = "logout-success.html"; 
            });
        });
    }

    // --- ഹിസ്റ്ററി കാണിക്കാനുള്ള ഫംഗ്‌ഷൻ ---
    window.renderHistory = function(uid) {
        const container = document.getElementById('historyContainer');
        const clearBtn = document.getElementById('clearBtn');
        const key = 'history_' + uid; // ഓരോ യൂസർക്കും പ്രത്യേക കീ
        
        const historyData = JSON.parse(localStorage.getItem(key)) || [];

        container.innerHTML = ''; // Clear loading text

        if (historyData.length === 0) {
            container.innerHTML = '<p class="no-history">നിങ്ങൾ ഇതുവരെ പുസ്തകങ്ങളൊന്നും വായിച്ചിട്ടില്ല.</p>';
            if(clearBtn) clearBtn.style.display = 'none';
            return;
        }

        if(clearBtn) clearBtn.style.display = 'block';

        historyData.forEach(book => {
            const card = document.createElement('div');
            card.className = 'history-card';
            card.innerHTML = `
                <img src="${book.image}" class="history-thumb" onerror="this.src='https://via.placeholder.com/60x85?text=Book'">
                <div class="history-details">
                    <span class="history-title">${book.title}</span>
                    <span class="history-date"><i class="far fa-clock"></i> ${book.date}</span>
                    <a href="${book.link}" class="read-link">വീണ്ടും വായിക്കുക <i class="fas fa-arrow-right"></i></a>
                </div>
            `;
            container.appendChild(card);
        });
    }

    // --- ഹിസ്റ്ററി ക്ലിയർ ചെയ്യാൻ ---
    window.clearHistory = function() {
        if (!currentUserId) return;
        if(confirm("വായനാ ചരിത്രം പൂർണ്ണമായും നീക്കം ചെയ്യട്ടെ?")) {
            localStorage.removeItem('history_' + currentUserId);
            renderHistory(currentUserId);
        }
    }
</script>

</body>
</html>
