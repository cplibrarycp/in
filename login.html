<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login | THRIPUDI LIBRARY</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Theme Variables --- */
        :root {
            --primary-teal: #00897B; 
            --secondary-dark: #004D40; 
            --text-white: #FFFFFF;
        }

        * { margin: 0; padding: 0; font-family: 'Poppins', sans-serif; box-sizing: border-box; }

        .hero {
            height: 100vh;
            width: 100%;
            background-image: linear-gradient(rgba(0, 77, 64, 0.85), rgba(0, 77, 64, 0.85)), url(https://images.unsplash.com/photo-1568667256549-094345857637?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80);
            background-position: center;
            background-size: cover;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .form-box {
            width: 380px;
            height: 580px; /* ഇമേജ് അപ്‌ലോഡ് വന്നതുകൊണ്ട് ഉയരം കൂട്ടി */
            position: relative;
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            padding: 5px;
            overflow: hidden;
            border-radius: 20px; 
        }

        /* --- Toggle Switch Design --- */
        .button-box {
            width: 240px;
            margin: 35px auto;
            position: relative;
            border-radius: 30px;
            background: rgba(0, 0, 0, 0.25);
            display: flex;
            justify-content: space-between;
            padding: 5px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }

        .toggle-btn {
            padding: 10px 0;
            cursor: pointer;
            background: transparent;
            border: 0;
            outline: none;
            position: relative;
            font-weight: 600;
            color: #ccc;
            flex: 1;
            transition: color 0.5s;
            z-index: 1;
            font-size: 14px;
        }

        #btn {
            top: 5px; left: 5px;
            position: absolute;
            width: 115px;
            height: calc(100% - 10px);
            background: #fff;
            border-radius: 25px;
            transition: .5s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .input-group {
            top: 150px; position: absolute; width: 280px; transition: .5s;
        }

        .input-field {
            width: 100%; padding: 10px 0; margin: 5px 0;
            border-left: 0; border-top: 0; border-right: 0;
            border-bottom: 1px solid #fff; 
            outline: none; background: transparent;
            color: #fff; 
            font-size: 14px;
        }
        
        ::placeholder { color: #ccc; opacity: 0.8; font-size: 13px; }

        .submit-btn {
            width: 85%; padding: 10px 30px; cursor: pointer; display: block; margin: auto;
            background: linear-gradient(to right, var(--primary-teal), var(--secondary-dark));
            border: 0; outline: none; border-radius: 30px; color: #fff; margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        
        .submit-btn:active { transform: scale(0.98); }

        .forgot-pass {
            display: block; text-align: center; margin-top: 15px; color: #fff;
            font-size: 12px; text-decoration: none; cursor: pointer; opacity: 0.8; transition: opacity 0.3s;
        }
        .forgot-pass:hover { opacity: 1; text-decoration: underline; }

        /* Profile Upload Styles */
        .profile-upload-container {
            text-align: center;
            margin-bottom: 10px;
        }
        .profile-preview {
            width: 70px; height: 70px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-teal);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            margin-bottom: 5px;
        }
        .upload-label {
            color: #fff; font-size: 11px; cursor: pointer; text-decoration: underline;
            display: block; opacity: 0.9;
        }
        .upload-status {
            color: yellow; font-size: 10px; margin-top: 2px; min-height: 15px;
        }

        #login { left: 50px; }
        #register { left: 450px; }
    </style>
</head>
<body>

    <div class="hero">
        <div class="form-box">
            <div class="button-box">
                <div id="btn"></div>
                <button type="button" class="toggle-btn" id="loginToggle" onclick="openLogin()" style="color: var(--primary-teal);">Log In</button>
                <button type="button" class="toggle-btn" id="regToggle" onclick="openRegister()">Register</button>
            </div>

            <div id="login" class="input-group">
                <input type="email" id="loginEmail" class="input-field" placeholder="Email Id" required>
                <input type="password" id="loginPassword" class="input-field" placeholder="Enter Password" required>
                <button type="button" class="submit-btn" id="loginBtn">Log In</button>
                <a href="#" class="forgot-pass" id="forgotPassBtn">Forgot Password?</a>
            </div>

            <div id="register" class="input-group">
                <div class="profile-upload-container">
                    <img id="previewImg" class="profile-preview" src="https://via.placeholder.com/100?text=User" alt="Profile">
                    <label for="fileInput" class="upload-label">Upload Profile Photo</label>
                    <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="uploadToDrive()">
                    <input type="hidden" id="uploadedImageUrl">
                    <p id="uploadStatus" class="upload-status"></p>
                </div>

                <input type="text" id="regUser" class="input-field" placeholder="User Name" required>
                <input type="email" id="regEmail" class="input-field" placeholder="Email Id" required>
                <input type="password" id="regPassword" class="input-field" placeholder="Enter Password (Min 6 chars)" required>
                <button type="button" class="submit-btn" id="regBtn">Register</button>
            </div>
        </div>
    </div>

    <script>
        var x = document.getElementById("login");
        var y = document.getElementById("register");
        var z = document.getElementById("btn");
        var loginToggle = document.getElementById("loginToggle");
        var regToggle = document.getElementById("regToggle");

        function openRegister() { 
            x.style.left = "-400px"; 
            y.style.left = "50px"; 
            z.style.left = "120px"; 
            loginToggle.style.color = "#ccc";
            regToggle.style.color = "var(--primary-teal)"; 
        }
        function openLogin() { 
            x.style.left = "50px"; 
            y.style.left = "450px"; 
            z.style.left = "5px"; 
            loginToggle.style.color = "var(--primary-teal)";
            regToggle.style.color = "#ccc";
        }
    </script>

    
    
    <div id="pdfModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:9999; flex-direction:column;">
        <div style="background:#004D40; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
            <span style="font-family:'Poppins',sans-serif; font-weight:600; font-size:1.1em;"> <i class="fas fa-book-reader"></i> Reading Mode</span>
            <button onclick="closePdfModal()" style="background:transparent; border:none; color:white; font-size:1.2em; cursor:pointer; padding:0 10px;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <iframe id="pdfFrame" style="width:100%; flex:1; border:none; display:block;"></iframe>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBzwhpHmeZdLf_nZrcPQirlnpj3Vhg9EqA", authDomain: "thripudilibrary.firebaseapp.com", projectId: "thripudilibrary", storageBucket: "thripudilibrary.firebasestorage.app", messagingSenderId: "887018912750", appId: "1:887018912750:web:cc05190a72b13db816acff", measurementId: "G-B59RDW4KG4" };
        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            const nameDisplay = document.getElementById('display-name');
            const avatarDiv = document.getElementById('userAvatar');

            if (user) {
                // --- 1. USER NAME SYNC FIX ---
                // പേജ് ലോഡ് ആകുമ്പോൾ തന്നെ വിവരങ്ങൾ നിർബന്ധമായും പുതുക്കുന്നു
                try { 
                    await user.reload(); 
                } catch(e) { 
                    console.log("Auto-reload error, using cached data"); 
                }
                
                // ഫയർബേസിൽ നിന്ന് ഏറ്റവും പുതിയ വിവരം എടുക്കുന്നു
                const currentUser = auth.currentUser; 
                
                // പേര് ഡിസ്പ്ലേ ചെയ്യുന്നു
                const displayName = currentUser.displayName ? currentUser.displayName.split(' ')[0] : currentUser.email.split('@')[0];
                if(nameDisplay) nameDisplay.textContent = displayName;
                
                // ഫോട്ടോ ഡിസ്പ്ലേ ചെയ്യുന്നു
                if (currentUser.photoURL && avatarDiv) {
                    avatarDiv.innerHTML = `<img src="${currentUser.photoURL}" alt="Profile">`;
                }

                // --- 2. SETUP CLICKS ---
                setupInteractions(user.uid);

            } else {
                // ലോഗിൻ ചെയ്തിട്ടില്ലെങ്കിൽ ഇൻഡക്സ് പേജിലേക്ക്
                if (!window.location.pathname.includes("index.html")) {
                     window.location.href = "index.html";
                }
            }
        });

        const logoutLink = document.getElementById('logout-link');
        if(logoutLink) {
            logoutLink.addEventListener('click', (e) => { 
                e.preventDefault(); 
                signOut(auth).then(() => { window.location.href = "index.html"; }); 
            });
        }

        // --- GLOBAL FUNCTIONS ---
        window.setupInteractions = function(uid) {
            const buttons = document.querySelectorAll(".overlay-btn");
            buttons.forEach(btn => {
                // പഴയ ഇവന്റുകൾ നീക്കം ചെയ്ത് പുതിയത് ചേർക്കുന്നു
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener("click", function(e) {
                    e.preventDefault(); // പുതിയ ടാബിൽ തുറക്കുന്നത് തടയുന്നു
                    
                    const card = this.closest('.book-card');
                    const linkUrl = this.getAttribute('href');
                    
                    // History Saving
                    if (card) {
                        const title = card.querySelector('.book-title').innerText;
                        const image = card.querySelector('.book-cover').src;
                        const date = new Date().toLocaleDateString('ml-IN');
                        
                        const key = 'history_' + uid;
                        let history = JSON.parse(localStorage.getItem(key)) || [];
                        history = history.filter(item => item.title !== title); // Remove duplicate
                        history.unshift({ title, image, url: linkUrl, date });
                        if (history.length > 50) history.pop();
                        localStorage.setItem(key, JSON.stringify(history));
                    }

                    // Open Full Page PDF
                    openPdfModal(linkUrl);
                });
            });
        };
    </script>

    <script>
        // --- FULL PAGE PDF LOGIC ---
        function openPdfModal(url) {
            const modal = document.getElementById('pdfModal');
            const frame = document.getElementById('pdfFrame');
            
            // Drive Link Conversion (Preview Mode)
            let embedUrl = url;
            if(url.includes("view") || url.includes("preview")) {
                embedUrl = url.replace(/\/view.*/, "/preview").replace(/\/preview.*/, "/preview");
            }
            
            frame.src = embedUrl;
            modal.style.display = "flex"; // Flex ഉപയോഗിച്ചാണ് ഫുൾ പേജ് സെറ്റ് ചെയ്യുന്നത്
            document.body.style.overflow = "hidden"; // പിന്നിലെ പേജ് സ്ക്രോൾ ആവാതിരിക്കാൻ
        }

        function closePdfModal() {
            const modal = document.getElementById('pdfModal');
            const frame = document.getElementById('pdfFrame');
            
            modal.style.display = "none";
            frame.src = ""; 
            document.body.style.overflow = "auto"; // സ്ക്രോൾ തിരികെ കൊണ്ടുവരുന്നു
        }

        function toggleProfileMenu() { 
            var dropdown = document.querySelector(".profile-dropdown"); 
            if(dropdown) dropdown.style.display = dropdown.style.display === "block" ? "none" : "block"; 
        }
        
        // ക്ലിക്ക് ഔട്ട്സൈഡ് (Dropdown Close)
        window.onclick = function(event) {
            if (!event.target.closest('.user-profile')) {
                var dropdowns = document.getElementsByClassName("profile-dropdown");
                for (var i = 0; i < dropdowns.length; i++) {
                    dropdowns[i].style.display = "none";
                }
            }
        }
        
        function searchBooks() { var input = document.getElementById('searchBar'); if(!input) return; var filter = input.value.toUpperCase(); var cards = document.getElementsByClassName('book-card'); for (var i = 0; i < cards.length; i++) { var title = cards[i].getElementsByClassName("book-title")[0]; if (title) { var txtValue = title.textContent || title.innerText; cards[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none"; } } }
    </script>
</body>
</html>


