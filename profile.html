<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzwhpHmeZdLf_nZrcPQirlnpj3Vhg9EqA", 
            authDomain: "thripudilibrary.firebaseapp.com",
            projectId: "thripudilibrary",
            storageBucket: "thripudilibrary.firebasestorage.app",
            messagingSenderId: "887018912750",
            appId: "1:887018912750:web:cc05190a72b13db816acff",
            measurementId: "G-B59RDW4KG4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- ഗൂഗിൾ ഡ്രൈവ് ലിങ്ക് ശരിയാക്കാനുള്ള ഫംഗ്ഷൻ ---
        function getDirectDriveLink(url) {
            if (!url) return "";
            // ഡ്രൈവ് ലിങ്ക് ആണെങ്കിൽ ID കണ്ടുപിടിച്ച് മാറ്റുന്നു
            if (url.includes("drive.google.com") && url.includes("/d/")) {
                const id = url.split("/d/")[1].split("/")[0];
                return `https://drive.google.com/uc?export=view&id=${id}`;
            }
            return url; // അല്ലെങ്കിൽ കൊടുത്ത ലിങ്ക് തന്നെ തിരിച്ചയക്കുന്നു
        }

        // --- ഫോട്ടോ സെറ്റ് ചെയ്യാനുള്ള ഫംഗ്ഷൻ ---
        function setProfileImage(imgUrl) {
            const validUrl = getDirectDriveLink(imgUrl);
            const avatarHtml = `<img src="${validUrl}" alt="Profile" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>';">`;
            
            // ഹെഡറിലെ ഫോട്ടോ
            const headerAvatar = document.getElementById('header-avatar');
            if(headerAvatar) headerAvatar.innerHTML = avatarHtml;

            // വലിയ ഫോട്ടോ
            const bigAvatar = document.getElementById('avatar-display-large');
            if(bigAvatar) bigAvatar.innerHTML = avatarHtml;
        }

        // 1. പേജ് ലോഡ് ആകുമ്പോൾ
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const displayName = user.displayName ? user.displayName : user.email.split('@')[0];
                document.getElementById('display-name').textContent = displayName;
                document.getElementById('email-field').value = user.email;
                document.getElementById('name-field').value = user.displayName || "";
                document.getElementById('photo-field').value = user.photoURL || "";

                if (user.photoURL) {
                    setProfileImage(user.photoURL);
                }
            } else {
                // window.location.href = "index.html"; 
            }
        });

        // 2. അപ്ഡേറ്റ് ബട്ടൺ ക്ലിക്ക് ചെയ്യുമ്പോൾ
        document.getElementById('update-btn').addEventListener('click', () => {
            const newName = document.getElementById('name-field').value;
            let newPhoto = document.getElementById('photo-field').value;
            const statusMsg = document.getElementById('status-message');
            const btn = document.getElementById('update-btn');

            btn.textContent = "Wait...";
            btn.disabled = true;

            // ഡ്രൈവ് ലിങ്ക് ആണെങ്കിൽ സേവ് ചെയ്യുന്നതിന് മുൻപേ ശരിയാക്കുന്നു
            newPhoto = getDirectDriveLink(newPhoto);

            updateProfile(auth.currentUser, {
                displayName: newName,
                photoURL: newPhoto
            }).then(() => {
                // ഉടനടി മാറ്റം വരുത്തുന്നു
                setProfileImage(newPhoto);
                if (newName) document.getElementById('display-name').textContent = newName;

                statusMsg.style.display = 'block';
                statusMsg.style.color = 'green';
                statusMsg.innerText = "✅ അപ്ഡേറ്റ് ചെയ്തു!";
                
                btn.textContent = "മാറ്റങ്ങൾ സേവ് ചെയ്യുക";
                btn.disabled = false;

                setTimeout(() => { statusMsg.style.display = 'none'; }, 3000);

            }).catch((error) => {
                statusMsg.style.display = 'block';
                statusMsg.style.color = 'red';
                statusMsg.innerText = "Error: " + error.message;
                btn.disabled = false;
            });
        });

        // 3. ലോഗൗട്ട് & പാസ്‌വേഡ് റീസെറ്റ് (Same as before)
        document.getElementById('logout-link').addEventListener('click', (e) => {
            e.preventDefault(); 
            signOut(auth).then(() => { window.location.href = "index.html"; });
        });

        document.getElementById('reset-pass-btn').addEventListener('click', () => {
            const email = auth.currentUser.email;
            if(confirm("പാസ്‌വേഡ് മാറ്റാനുള്ള ലിങ്ക് അയക്കട്ടെ?")) {
                sendPasswordResetEmail(auth, email)
                    .then(() => alert("ലിങ്ക് അയച്ചു."))
                    .catch((error) => alert("Error: " + error.message));
            }
        });

    </script>
