<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>‡¥™‡µç‡¥∞‡µä‡¥´‡µà‡µΩ ‡¥ï‡µç‡¥∞‡¥Æ‡µÄ‡¥ï‡¥∞‡¥£‡¥ô‡µç‡¥ô‡µæ | THRIPUDI LIBRARY</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
    <style>
        :root { --primary-teal: #00897B; --secondary-dark: #004D40; --background-light: #E0F2F1; --text-color: #263238; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-light); min-height: 100vh; display: flex; flex-direction: column; }
        .container { width: 85%; margin: 0 auto; max-width: 1200px; }
        header { background-color: var(--secondary-dark); padding: 5px 0; height: 90px; display: flex; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 1000; }
        .navbar { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .logo-container { display: flex; align-items: center; gap: 12px; color: #FFFFFF !important; text-decoration: none; font-size: 1.5em; font-weight: 700; }
        .logo-img { height: 60px; }
        .profile-card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); max-width: 550px; margin: 50px auto; text-align: center; }
        
        /* ‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥è‡¥∞‡¥ø‡¥Ø */
        .avatar-container { position: relative; width: 120px; height: 120px; margin: 0 auto 25px; }
        .avatar-large { width: 100%; height: 100%; background: var(--primary-teal); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3.5em; overflow: hidden; border: 5px solid #B2DFDB; }
        .avatar-large img { width: 100%; height: 100%; object-fit: cover; }
        .upload-badge { position: absolute; bottom: 5px; right: 5px; background: var(--secondary-dark); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid white; }
        
        .form-group { margin-bottom: 20px; text-align: left; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9em; color: var(--secondary-dark); }
        input { width: 100%; padding: 12px; border: 2px solid #B2DFDB; border-radius: 10px; font-size: 1em; outline: none; }
        .btn-save { background: var(--primary-teal); color: white; border: none; padding: 15px; border-radius: 10px; width: 100%; font-weight: 700; cursor: pointer; margin-top: 10px; }
        footer { background: var(--secondary-dark); color: white; text-align: center; padding: 25px 0; margin-top: auto; }
        #loadingOverlay { display:none; color: var(--primary-teal); font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <div class="container navbar">
        <a href="dashboard.html" class="logo-container">
            <img src="https://drive.google.com/thumbnail?sz=w600&id=1DuMrsRg-QsW9mf5lV4uK8eWn8oiofz5r" class="logo-img">
            <span>THRIPUDI</span>
        </a>
        <div style="display:flex; gap:15px;">
            <a href="dashboard.html" style="color:white; text-decoration:none; font-weight:600;">HOME</a>
            <a href="history.html" style="color:white; text-decoration:none; font-weight:600;">HISTORY</a>
        </div>
    </div>
</header>

<div class="container">
    <div class="profile-card">
        <div class="avatar-container">
            <div class="avatar-large" id="profileAvatar"><i class="fas fa-user"></i></div>
            <label for="fileInput" class="upload-badge"><i class="fas fa-camera"></i></label>
            <input type="file" id="fileInput" style="display:none;" accept="image/*">
        </div>
        
        <div id="loadingOverlay">‡¥ö‡¥ø‡¥§‡µç‡¥∞‡¥Ç ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ...</div>

        <div class="form-group">
            <label>‡¥™‡µá‡¥∞‡µç</label>
            <input type="text" id="nameInput">
        </div>
        
        <div class="form-group">
            <label>‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç (‡¥ì‡¥ü‡µç‡¥ü‡µã‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ø‡¥ø ‡¥µ‡¥∞‡µÅ‡¥Ç)</label>
            <input type="text" id="photoInput" placeholder="Upload ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥æ‡µΩ ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ ‡¥µ‡¥∞‡µÅ‡¥Ç">
        </div>
        
        <button class="btn-save" id="saveProfileBtn">‡¥™‡µç‡¥∞‡µä‡¥´‡µà‡µΩ ‡¥Ö‡¥™‡µç‚Äå‡¥°‡µá‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>
        <p id="statusBox" style="margin-top:15px; font-weight:bold;"></p>
    </div>
</div>

<footer>¬© 2025 THRIPUDI LIBRARY</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyBzwhpHmeZdLf_nZrcPQirlnpj3Vhg9EqA", authDomain: "thripudilibrary.firebaseapp.com", projectId: "thripudilibrary" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    // ‚úÖ Apps Script URL (‡¥á‡¥µ‡¥ø‡¥ü‡µÜ ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥™‡¥¥‡¥Ø ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç ‡¥™‡µá‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï)
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw8b1l6poc0fDGAVXZRV1LQW8_TXS0ozu0rxjHDzHx0P32zBfk4UcSDcdu9q16KL91lLw/exec";

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('nameInput').value = user.displayName || "";
            document.getElementById('photoInput').value = user.photoURL || "";
            if(user.photoURL) document.getElementById('profileAvatar').innerHTML = `<img src="${user.photoURL}">`;
        } else {
            window.location.href = "login.html";
        }
    });

    // üì∏ ‡¥°‡µç‡¥∞‡µà‡¥µ‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥® ‡¥≤‡µã‡¥ú‡¥ø‡¥ï‡µç
    document.getElementById('fileInput').addEventListener('change', function() {
        const file = this.files[0];
        if (!file) return;

        const reader = new FileReader();
        document.getElementById('loadingOverlay').style.display = "block";

        reader.onload = function(e) {
            const base64 = e.target.result.split(',')[1];
            
            fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ file: base64, filename: file.name, type: file.type })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loadingOverlay').style.display = "none";
                if(data.url) {
                    document.getElementById('photoInput').value = data.url;
                    document.getElementById('profileAvatar').innerHTML = `<img src="${data.url}">`;
                    alert("‡¥ö‡¥ø‡¥§‡µç‡¥∞‡¥Ç ‡¥±‡µÜ‡¥°‡¥ø‡¥Ø‡¥æ‡¥Ø‡¥ø! ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥ô‡µç‡¥ô‡µæ ‡¥∏‡µá‡¥µ‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï.");
                }
            })
            .catch(err => alert("‡¥Ö‡¥™‡µç‚Äå‡¥≤‡µã‡¥°‡µç ‡¥™‡¥∞‡¥æ‡¥ú‡¥Ø‡¥™‡µç‡¥™‡µÜ‡¥ü‡µç‡¥ü‡µÅ. ‡¥≤‡¥ø‡¥ô‡µç‡¥ï‡µç ‡¥™‡¥∞‡¥ø‡¥∂‡µã‡¥ß‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï."));
        };
        reader.readAsDataURL(file);
    });

    document.getElementById('saveProfileBtn').onclick = async () => {
        const user = auth.currentUser;
        try {
            await updateProfile(user, {
                displayName: document.getElementById('nameInput').value,
                photoURL: document.getElementById('photoInput').value
            });
            alert("‡¥™‡µç‡¥∞‡µä‡¥´‡µà‡µΩ ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥ï‡¥∞‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥Ö‡¥™‡µç‚Äå‡¥°‡µá‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µÅ!");
            location.reload();
        } catch (e) { alert(e.message); }
    };
</script>
</body>
</html>
