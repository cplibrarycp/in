<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, updateProfile, sendPasswordResetEmail, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBzwhpHmeZdLf_nZrcPQirlnpj3Vhg9EqA", 
            authDomain: "thripudilibrary.firebaseapp.com",
            projectId: "thripudilibrary",
            storageBucket: "thripudilibrary.firebasestorage.app",
            messagingSenderId: "887018912750",
            appId: "1:887018912750:web:cc05190a72b13db816acff",
            measurementId: "G-B59RDW4KG4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- IMPROVED: ഡ്രൈവ് ലിങ്ക് കൺവെർട്ടർ ---
        function getDirectDriveLink(url) {
            if (!url) return "";
            
            let fileId = "";
            
            // പാറ്റേൺ 1: https://drive.google.com/file/d/FILE_ID/view...
            if (url.indexOf("/d/") !== -1) {
                fileId = url.split("/d/")[1].split("/")[0];
            }
            // പാറ്റേൺ 2: https://drive.google.com/open?id=FILE_ID
            else if (url.indexOf("id=") !== -1) {
                fileId = url.split("id=")[1].split("&")[0];
            }

            // ഐഡി കിട്ടിയാൽ ഡയറക്ട് ലിങ്ക് ആക്കുന്നു
            if (fileId) {
                return `https://lh3.googleusercontent.com/d/${fileId}`;
            }
            
            return url; // ഡ്രൈവ് ലിങ്ക് അല്ലെങ്കിൽ കൊടുത്തത് തന്നെ തിരിച്ചയക്കുന്നു
        }

        // --- ഫോട്ടോ സെറ്റ് ചെയ്യുന്നു ---
        function setProfileImage(imgUrl) {
            const validUrl = getDirectDriveLink(imgUrl);
            const avatarHtml = `<img src="${validUrl}" alt="Profile" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\\'fas fa-user\\'></i>';">`;
            
            document.getElementById('header-avatar').innerHTML = avatarHtml;
            document.getElementById('avatar-display-large').innerHTML = avatarHtml;
        }

        // 1. പേജ് ലോഡ് ആകുമ്പോൾ
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const displayName = user.displayName ? user.displayName : user.email.split('@')[0];
                document.getElementById('display-name').textContent = displayName;
                document.getElementById('email-field').value = user.email;
                document.getElementById('name-field').value = user.displayName || "";
                
                // ഇൻപുട്ട് ബോക്സിൽ ഒറിജിനൽ ലിങ്ക് തന്നെ കാണിക്കുന്നു
                document.getElementById('photo-field').value = user.photoURL || "";

                if (user.photoURL) {
                    setProfileImage(user.photoURL);
                }
            } else {
                window.location.href = "index.html"; 
            }
        });

        // 2. അപ്ഡേറ്റ് ബട്ടൺ
        document.getElementById('update-btn').addEventListener('click', () => {
            const newName = document.getElementById('name-field').value;
            const originalPhotoUrl = document.getElementById('photo-field').value;
            const statusMsg = document.getElementById('status-message');
            const btn = document.getElementById('update-btn');

            btn.textContent = "Wait...";
            btn.disabled = true;

            // ഫയർബേസിലേക്ക് ഒറിജിനൽ ലിങ്ക് തന്നെ സേവ് ചെയ്യുന്നു
            // (ഡിസ്പ്ലേ ചെയ്യുമ്പോൾ നമ്മൾ കൺവെർട്ട് ചെയ്തോളാം)
            
            updateProfile(auth.currentUser, {
                displayName: newName,
                photoURL: originalPhotoUrl 
            }).then(() => {
                
                // സ്ക്രീനിൽ കാണിക്കാൻ കൺവെർട്ട് ചെയ്യുന്നു
                setProfileImage(originalPhotoUrl);
                
                if (newName) document.getElementById('display-name').textContent = newName;

                statusMsg.style.display = 'block';
                statusMsg.style.color = 'green';
                statusMsg.innerText = "✅ അപ്ഡേറ്റ് ചെയ്തു!";
                
                btn.textContent = "മാറ്റങ്ങൾ സേവ് ചെയ്യുക";
                btn.disabled = false;

                setTimeout(() => { statusMsg.style.display = 'none'; }, 3000);

            }).catch((error) => {
                statusMsg.style.display = 'block';
                statusMsg.style.color = 'red';
                statusMsg.innerText = "Error: " + error.message;
                btn.textContent = "മാറ്റങ്ങൾ സേവ് ചെയ്യുക";
                btn.disabled = false;
            });
        });

        // 3. Logout & Reset
        document.getElementById('logout-link').addEventListener('click', (e) => {
            e.preventDefault(); 
            signOut(auth).then(() => { window.location.href = "index.html"; });
        });

        document.getElementById('reset-pass-btn').addEventListener('click', () => {
            const email = auth.currentUser.email;
            if(confirm("പാസ്‌വേഡ് മാറ്റാനുള്ള ലിങ്ക് അയക്കട്ടെ?")) {
                sendPasswordResetEmail(auth, email)
                    .then(() => alert("ലിങ്ക് അയച്ചു."))
                    .catch((error) => alert("Error: " + error.message));
            }
        });

    </script>
