<!DOCTYPE html>

<html lang="ml">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>‡¥µ‡¥æ‡¥Ø‡¥®‡¥∂‡¥æ‡¥≤ | THRIPUDI LIBRARY</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&amp;display=swap" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet"/>
<style>
        :root {
            --primary-orange: #00897B;
            --secondary-dark: #004D40;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #202124;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
        }

        /* --- ‡¥ü‡µã‡¥™‡µç‡¥™‡µç ‡¥¨‡¥æ‡µº --- */
        .top-bar {
            height: 50px;
            background: var(--secondary-dark);
            color: white;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .back-btn:hover {
            color: #ccc;
        }

        .logo-text {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* --- PDF ‡¥ï‡¥£‡µç‡¥ü‡µÜ‡¥Ø‡µç‡¥®‡µº --- */
        .pdf-container {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative; /* ‡¥á‡¥§‡µç ‡¥™‡µç‡¥∞‡¥ß‡¥æ‡¥®‡¥Ç */
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* --- Pop-out ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ ‡¥¨‡µç‡¥≤‡µã‡¥ï‡µç‡¥ï‡µº (TRICK) --- */
        .popout-blocker {
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;  /* ‡¥¨‡¥ü‡µç‡¥ü‡¥®‡µç‡¥±‡µÜ ‡¥è‡¥ï‡¥¶‡µá‡¥∂ ‡¥µ‡µÄ‡¥§‡¥ø */
            height: 60px; /* ‡¥¨‡¥ü‡µç‡¥ü‡¥®‡µç‡¥±‡µÜ ‡¥è‡¥ï‡¥¶‡µá‡¥∂ ‡¥â‡¥Ø‡¥∞‡¥Ç */
            background: transparent; /* ‡¥∏‡µÅ‡¥§‡¥æ‡¥∞‡µç‡¥Ø‡¥Ç (‡¥ï‡¥æ‡¥£‡¥ø‡¥≤‡µç‡¥≤) */
            z-index: 20; /* iframe-‡¥®‡µç ‡¥Æ‡µÅ‡¥ï‡¥≥‡¥ø‡µΩ */
            cursor: default;
        }

    </style>
</head>
<body>
<div class="top-bar">
<a class="back-btn" href="javascript:history.back()">
<i class="fas fa-arrow-left"></i> ‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µÜ
        </a>
<span class="logo-text">THRIPUDI READ MODE</span>
</div>
<div class="pdf-container">
<iframe allow="autoplay" id="pdf-frame" src=""></iframe>
<div class="popout-blocker" title="Pop-out disabled"></div>
</div>
<script>
        // URL-‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥´‡¥Ø‡µΩ ID ‡¥é‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('id');

        if (!fileId) {
            alert("‡¥™‡µÅ‡¥∏‡µç‡¥§‡¥ï‡¥Ç ‡¥ï‡¥£‡µç‡¥ü‡µÜ‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥ø‡¥≤‡µç‡¥≤!");
            window.location.href = 'dashboard.html';
        } else {
            // Preview URL
            const driveUrl = `https://drive.google.com/file/d/${fileId}/preview`;
            document.getElementById('pdf-frame').src = driveUrl;
        }
    </script>
<div id="pdfModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:9999; flex-direction:column;">
<div style="background:#004D40; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
<span style="font-family:'Poppins',sans-serif; font-weight:600; font-size:1.1em;"> <i class="fas fa-book-reader"></i> Reading Mode</span>
<button onclick="closePdfModal()" style="background:transparent; border:none; color:white; font-size:1.2em; cursor:pointer; padding:0 10px;">
<i class="fas fa-times"></i> Close
            </button>
</div>
<iframe id="pdfFrame" style="width:100%; flex:1; border:none; display:block;"></iframe>
</div>
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBzwhpHmeZdLf_nZrcPQirlnpj3Vhg9EqA", authDomain: "thripudilibrary.firebaseapp.com", projectId: "thripudilibrary", storageBucket: "thripudilibrary.firebasestorage.app", messagingSenderId: "887018912750", appId: "1:887018912750:web:cc05190a72b13db816acff", measurementId: "G-B59RDW4KG4" };
        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            const nameDisplay = document.getElementById('display-name');
            const avatarDiv = document.getElementById('userAvatar');

            if (user) {
                // --- 1. USER NAME SYNC FIX ---
                // ‡¥™‡µá‡¥ú‡µç ‡¥≤‡µã‡¥°‡µç ‡¥Ü‡¥ï‡µÅ‡¥Æ‡µç‡¥™‡µã‡µæ ‡¥§‡¥®‡µç‡¥®‡µÜ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥®‡¥ø‡µº‡¥¨‡¥®‡µç‡¥ß‡¥Æ‡¥æ‡¥Ø‡µÅ‡¥Ç ‡¥™‡µÅ‡¥§‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
                try { 
                    await user.reload(); 
                } catch(e) { 
                    console.log("Auto-reload error, using cached data"); 
                }
                
                // ‡¥´‡¥Ø‡µº‡¥¨‡µá‡¥∏‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥è‡¥±‡µç‡¥±‡¥µ‡µÅ‡¥Ç ‡¥™‡µÅ‡¥§‡¥ø‡¥Ø ‡¥µ‡¥ø‡¥µ‡¥∞‡¥Ç ‡¥é‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
                const currentUser = auth.currentUser; 
                
                // ‡¥™‡µá‡¥∞‡µç ‡¥°‡¥ø‡¥∏‡µç‡¥™‡µç‡¥≤‡µá ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
                const displayName = currentUser.displayName ? currentUser.displayName.split(' ')[0] : currentUser.email.split('@')[0];
                if(nameDisplay) nameDisplay.textContent = displayName;
                
                // ‡¥´‡µã‡¥ü‡µç‡¥ü‡µã ‡¥°‡¥ø‡¥∏‡µç‡¥™‡µç‡¥≤‡µá ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
                if (currentUser.photoURL && avatarDiv) {
                    avatarDiv.innerHTML = `<img src="${currentUser.photoURL}" alt="Profile">`;
                }

                // --- 2. SETUP CLICKS ---
                setupInteractions(user.uid);

            } else {
                // ‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥ø‡¥ü‡µç‡¥ü‡¥ø‡¥≤‡µç‡¥≤‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥á‡µª‡¥°‡¥ï‡µç‡¥∏‡µç ‡¥™‡µá‡¥ú‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç
                if (!window.location.pathname.includes("index.html")) {
                     window.location.href = "index.html";
                }
            }
        });

        const logoutLink = document.getElementById('logout-link');
        if(logoutLink) {
            logoutLink.addEventListener('click', (e) => { 
                e.preventDefault(); 
                signOut(auth).then(() => { window.location.href = "index.html"; }); 
            });
        }

        // --- GLOBAL FUNCTIONS ---
        window.setupInteractions = function(uid) {
            const buttons = document.querySelectorAll(".overlay-btn");
            buttons.forEach(btn => {
                // ‡¥™‡¥¥‡¥Ø ‡¥á‡¥µ‡¥®‡µç‡¥±‡µÅ‡¥ï‡µæ ‡¥®‡µÄ‡¥ï‡µç‡¥ï‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡µç ‡¥™‡µÅ‡¥§‡¥ø‡¥Ø‡¥§‡µç ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener("click", function(e) {
                    e.preventDefault(); // ‡¥™‡µÅ‡¥§‡¥ø‡¥Ø ‡¥ü‡¥æ‡¥¨‡¥ø‡µΩ ‡¥§‡µÅ‡¥±‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡µç ‡¥§‡¥ü‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
                    
                    const card = this.closest('.book-card');
                    const linkUrl = this.getAttribute('href');
                    
                    // History Saving
                    if (card) {
                        const title = card.querySelector('.book-title').innerText;
                        const image = card.querySelector('.book-cover').src;
                        const date = new Date().toLocaleDateString('ml-IN');
                        
                        const key = 'history_' + uid;
                        let history = JSON.parse(localStorage.getItem(key)) || [];
                        history = history.filter(item => item.title !== title); // Remove duplicate
                        history.unshift({ title, image, url: linkUrl, date });
                        if (history.length > 50) history.pop();
                        localStorage.setItem(key, JSON.stringify(history));
                    }

                    // Open Full Page PDF
                    openPdfModal(linkUrl);
                });
            });
        };
    </script>
<script>
        // --- FULL PAGE PDF LOGIC ---
        function openPdfModal(url) {
            const modal = document.getElementById('pdfModal');
            const frame = document.getElementById('pdfFrame');
            
            // Drive Link Conversion (Preview Mode)
            let embedUrl = url;
            if(url.includes("view") || url.includes("preview")) {
                embedUrl = url.replace(/\/view.*/, "/preview").replace(/\/preview.*/, "/preview");
            }
            
            frame.src = embedUrl;
            modal.style.display = "flex"; // Flex ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡¥æ‡¥£‡µç ‡¥´‡µÅ‡µæ ‡¥™‡µá‡¥ú‡µç ‡¥∏‡µÜ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡¥§‡µç
            document.body.style.overflow = "hidden"; // ‡¥™‡¥ø‡¥®‡µç‡¥®‡¥ø‡¥≤‡µÜ ‡¥™‡µá‡¥ú‡µç ‡¥∏‡µç‡¥ï‡µç‡¥∞‡µã‡µæ ‡¥Ü‡¥µ‡¥æ‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µª
        }

        function closePdfModal() {
            const modal = document.getElementById('pdfModal');
            const frame = document.getElementById('pdfFrame');
            
            modal.style.display = "none";
            frame.src = ""; 
            document.body.style.overflow = "auto"; // ‡¥∏‡µç‡¥ï‡µç‡¥∞‡µã‡µæ ‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µÜ ‡¥ï‡µä‡¥£‡µç‡¥ü‡µÅ‡¥µ‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ
        }

        function toggleProfileMenu() { 
            var dropdown = document.querySelector(".profile-dropdown"); 
            if(dropdown) dropdown.style.display = dropdown.style.display === "block" ? "none" : "block"; 
        }
        
        // ‡¥ï‡µç‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥î‡¥ü‡µç‡¥ü‡µç‡¥∏‡µà‡¥°‡µç (Dropdown Close)
        window.onclick = function(event) {
            if (!event.target.closest('.user-profile')) {
                var dropdowns = document.getElementsByClassName("profile-dropdown");
                for (var i = 0; i < dropdowns.length; i++) {
                    dropdowns[i].style.display = "none";
                }
            }
        }
        
        function searchBooks() { var input = document.getElementById('searchBar'); if(!input) return; var filter = input.value.toUpperCase(); var cards = document.getElementsByClassName('book-card'); for (var i = 0; i < cards.length; i++) { var title = cards[i].getElementsByClassName("book-title")[0]; if (title) { var txtValue = title.textContent || title.innerText; cards[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none"; } } }
    </script>

<style>
    .auth-modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); justify-content: center; align-items: center; }
    .auth-box { background: #ffffff; padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); border-top: 6px solid #00897B; font-family: 'Poppins', sans-serif; animation: fadeIn 0.3s ease-in-out; }
    .auth-box h3 { color: #004D40; margin-top: 0; }
    .auth-box p { color: #555; font-size: 16px; margin-bottom: 25px; }
    .auth-btn-login { background-color: #00897B; color: white; border: none; padding: 10px 25px; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s; margin: 5px; }
    .auth-btn-login:hover { background-color: #004D40; transform: translateY(-2px); }
    .auth-btn-cancel { background-color: transparent; color: #777; border: 1px solid #ccc; padding: 10px 25px; border-radius: 50px; cursor: pointer; font-weight: bold; font-size: 14px; transition: 0.3s; margin: 5px; }
    .auth-btn-cancel:hover { background-color: #f1f1f1; color: #333; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
</style>
<div class="auth-modal" id="authModal">
<div class="auth-box">
<h3>‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥æ‡¥£‡µç üîí</h3>
<p>‡¥à ‡¥™‡µÅ‡¥∏‡µç‡¥§‡¥ï‡¥Ç ‡¥µ‡¥æ‡¥Ø‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡¥§‡¥ø‡¥®‡¥æ‡¥Ø‡¥ø ‡¥§‡¥æ‡¥ô‡µç‡¥ï‡µæ ‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µá‡¥£‡µç‡¥ü‡¥§‡µÅ‡¥£‡µç‡¥ü‡µç. ‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥™‡µá‡¥ú‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥™‡µã‡¥ï‡¥ü‡µç‡¥ü‡µá?</p>
<button class="auth-btn-login" onclick="redirectToLogin()">‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥ï</button>
<button class="auth-btn-cancel" onclick="closeAuthModal()">‡¥™‡¥ø‡¥®‡µç‡¥®‡µÄ‡¥ü‡¥æ‡¥µ‡¥æ‡¥Ç</button>
</div>
</div>
<script id="accessScript">
    function checkReadAccess(pdfUrl) {
        var currentUser = localStorage.getItem('libraryUser');
        if (currentUser) {
            window.open(pdfUrl, '_blank');
        } else {
            sessionStorage.setItem('pendingBook', pdfUrl);
            document.getElementById('authModal').style.display = 'flex';
        }
    }
    function redirectToLogin() { window.location.href = 'login.html'; }
    function closeAuthModal() { document.getElementById('authModal').style.display = 'none'; }
    window.onclick = function(event) {
        var modal = document.getElementById('authModal');
        if (event.target == modal) { closeAuthModal(); }
    }
</script>
</body>
</html>
