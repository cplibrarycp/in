<!DOCTYPE html>
<html lang="ml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>വായനശാല | THRIPUDI LIBRARY</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <style>
        :root {
            --primary-orange: #00897B;
            --secondary-dark: #004D40;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #202124;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
        }

        /* --- ടോപ്പ് ബാർ --- */
        .top-bar {
            height: 50px;
            background: var(--secondary-dark);
            color: white;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .back-btn:hover {
            color: #ccc;
        }

        .logo-text {
            font-size: 0.9em;
            opacity: 0.8;
        }

        /* --- PDF കണ്ടെയ്നർ --- */
        .pdf-container {
            flex: 1;
            width: 100%;
            height: 100%;
            position: relative; /* ഇത് പ്രധാനം */
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }

        /* --- Pop-out ബട്ടൺ ബ്ലോക്കർ (TRICK) --- */
        .popout-blocker {
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;  /* ബട്ടന്റെ ഏകദേശ വീതി */
            height: 60px; /* ബട്ടന്റെ ഏകദേശ ഉയരം */
            background: transparent; /* സുതാര്യം (കാണില്ല) */
            z-index: 20; /* iframe-ന് മുകളിൽ */
            cursor: default;
        }

    </style>
</head>
<body>

    <div class="top-bar">
        <a href="javascript:history.back()" class="back-btn">
            <i class="fas fa-arrow-left"></i> തിരികെ
        </a>
        <span class="logo-text">THRIPUDI READ MODE</span>
    </div>

    <div class="pdf-container">
        <iframe id="pdf-frame" src="" allow="autoplay"></iframe>
        
        <div class="popout-blocker" title="Pop-out disabled"></div>
    </div>

    <script>
        // URL-ൽ നിന്ന് ഫയൽ ID എടുക്കുന്നു
        const urlParams = new URLSearchParams(window.location.search);
        const fileId = urlParams.get('id');

        if (!fileId) {
            alert("പുസ്തകം കണ്ടെത്തിയില്ല!");
            window.location.href = 'dashboard.html';
        } else {
            // Preview URL
            const driveUrl = `https://drive.google.com/file/d/${fileId}/preview`;
            document.getElementById('pdf-frame').src = driveUrl;
        }
    </script>


    
    <div id="pdfModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:9999; flex-direction:column;">
        <div style="background:#004D40; color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.2);">
            <span style="font-family:'Poppins',sans-serif; font-weight:600; font-size:1.1em;"> <i class="fas fa-book-reader"></i> Reading Mode</span>
            <button onclick="closePdfModal()" style="background:transparent; border:none; color:white; font-size:1.2em; cursor:pointer; padding:0 10px;">
                <i class="fas fa-times"></i> Close
            </button>
        </div>
        <iframe id="pdfFrame" style="width:100%; flex:1; border:none; display:block;"></iframe>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyBzwhpHmeZdLf_nZrcPQirlnpj3Vhg9EqA", authDomain: "thripudilibrary.firebaseapp.com", projectId: "thripudilibrary", storageBucket: "thripudilibrary.firebasestorage.app", messagingSenderId: "887018912750", appId: "1:887018912750:web:cc05190a72b13db816acff", measurementId: "G-B59RDW4KG4" };
        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app);

        onAuthStateChanged(auth, async (user) => {
            const nameDisplay = document.getElementById('display-name');
            const avatarDiv = document.getElementById('userAvatar');

            if (user) {
                // --- 1. USER NAME SYNC FIX ---
                // പേജ് ലോഡ് ആകുമ്പോൾ തന്നെ വിവരങ്ങൾ നിർബന്ധമായും പുതുക്കുന്നു
                try { 
                    await user.reload(); 
                } catch(e) { 
                    console.log("Auto-reload error, using cached data"); 
                }
                
                // ഫയർബേസിൽ നിന്ന് ഏറ്റവും പുതിയ വിവരം എടുക്കുന്നു
                const currentUser = auth.currentUser; 
                
                // പേര് ഡിസ്പ്ലേ ചെയ്യുന്നു
                const displayName = currentUser.displayName ? currentUser.displayName.split(' ')[0] : currentUser.email.split('@')[0];
                if(nameDisplay) nameDisplay.textContent = displayName;
                
                // ഫോട്ടോ ഡിസ്പ്ലേ ചെയ്യുന്നു
                if (currentUser.photoURL && avatarDiv) {
                    avatarDiv.innerHTML = `<img src="${currentUser.photoURL}" alt="Profile">`;
                }

                // --- 2. SETUP CLICKS ---
                setupInteractions(user.uid);

            } else {
                // ലോഗിൻ ചെയ്തിട്ടില്ലെങ്കിൽ ഇൻഡക്സ് പേജിലേക്ക്
                if (!window.location.pathname.includes("index.html")) {
                     window.location.href = "index.html";
                }
            }
        });

        const logoutLink = document.getElementById('logout-link');
        if(logoutLink) {
            logoutLink.addEventListener('click', (e) => { 
                e.preventDefault(); 
                signOut(auth).then(() => { window.location.href = "index.html"; }); 
            });
        }

        // --- GLOBAL FUNCTIONS ---
        window.setupInteractions = function(uid) {
            const buttons = document.querySelectorAll(".overlay-btn");
            buttons.forEach(btn => {
                // പഴയ ഇവന്റുകൾ നീക്കം ചെയ്ത് പുതിയത് ചേർക്കുന്നു
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener("click", function(e) {
                    e.preventDefault(); // പുതിയ ടാബിൽ തുറക്കുന്നത് തടയുന്നു
                    
                    const card = this.closest('.book-card');
                    const linkUrl = this.getAttribute('href');
                    
                    // History Saving
                    if (card) {
                        const title = card.querySelector('.book-title').innerText;
                        const image = card.querySelector('.book-cover').src;
                        const date = new Date().toLocaleDateString('ml-IN');
                        
                        const key = 'history_' + uid;
                        let history = JSON.parse(localStorage.getItem(key)) || [];
                        history = history.filter(item => item.title !== title); // Remove duplicate
                        history.unshift({ title, image, url: linkUrl, date });
                        if (history.length > 50) history.pop();
                        localStorage.setItem(key, JSON.stringify(history));
                    }

                    // Open Full Page PDF
                    openPdfModal(linkUrl);
                });
            });
        };
    </script>

    <script>
        // --- FULL PAGE PDF LOGIC ---
        function openPdfModal(url) {
            const modal = document.getElementById('pdfModal');
            const frame = document.getElementById('pdfFrame');
            
            // Drive Link Conversion (Preview Mode)
            let embedUrl = url;
            if(url.includes("view") || url.includes("preview")) {
                embedUrl = url.replace(/\/view.*/, "/preview").replace(/\/preview.*/, "/preview");
            }
            
            frame.src = embedUrl;
            modal.style.display = "flex"; // Flex ഉപയോഗിച്ചാണ് ഫുൾ പേജ് സെറ്റ് ചെയ്യുന്നത്
            document.body.style.overflow = "hidden"; // പിന്നിലെ പേജ് സ്ക്രോൾ ആവാതിരിക്കാൻ
        }

        function closePdfModal() {
            const modal = document.getElementById('pdfModal');
            const frame = document.getElementById('pdfFrame');
            
            modal.style.display = "none";
            frame.src = ""; 
            document.body.style.overflow = "auto"; // സ്ക്രോൾ തിരികെ കൊണ്ടുവരുന്നു
        }

        function toggleProfileMenu() { 
            var dropdown = document.querySelector(".profile-dropdown"); 
            if(dropdown) dropdown.style.display = dropdown.style.display === "block" ? "none" : "block"; 
        }
        
        // ക്ലിക്ക് ഔട്ട്സൈഡ് (Dropdown Close)
        window.onclick = function(event) {
            if (!event.target.closest('.user-profile')) {
                var dropdowns = document.getElementsByClassName("profile-dropdown");
                for (var i = 0; i < dropdowns.length; i++) {
                    dropdowns[i].style.display = "none";
                }
            }
        }
        
        function searchBooks() { var input = document.getElementById('searchBar'); if(!input) return; var filter = input.value.toUpperCase(); var cards = document.getElementsByClassName('book-card'); for (var i = 0; i < cards.length; i++) { var title = cards[i].getElementsByClassName("book-title")[0]; if (title) { var txtValue = title.textContent || title.innerText; cards[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none"; } } }
    </script>
</body>
</html>


</html>